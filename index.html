<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Crash Cart Expiration Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    :root {
      --critical-bg: #ffebee;
      --critical-text: #b71c1c;
      --critical-border: #b71c1c;

      --warning-bg: #fff8e1;
      --warning-text: #ff6f00;
      --warning-border: #ff6f00;

      --ok-bg: #e8f5e9;
      --ok-text: #2e7d32;
      --ok-border: #2e7d32;

      --expired-bg: #f3e5f5;
      --expired-text: #4a148c;
      --expired-border: #4a148c;
    }

    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      max-width: 1200px;
      margin: 0 auto;
      line-height: 1.5;
      font-size: 16px;
      background: #f7f7f7;
    }

    h1 {
      margin-bottom: 6px;
      font-size: 1.6rem;
    }

    p {
      margin-top: 0;
      color: #555;
      font-size: 0.95rem;
    }

    .top-actions {
      margin: 10px 0 15px;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
    }

    .top-actions button {
      padding: 6px 12px;
      font-size: 0.85rem;
      border-radius: 4px;
      border: 1px solid #888;
      background: #ffffff;
      cursor: pointer;
    }

    .top-actions button:hover {
      background: #f0f0f0;
    }

    .units-container {
      margin-top: 5px;
    }

    .unit-section {
      margin-top: 20px;
      border: 1px solid #ccc;
      border-radius: 8px;
      background: #ffffff;
      overflow: hidden;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.06);
    }

    .unit-header {
      background: #e3e3e3;
      padding: 14px 16px;
      cursor: pointer;
      font-size: 1.1rem;
      font-weight: bold;
      display: flex;
      justify-content: space-between;
      align-items: center;
      outline: none;
    }

    .unit-header:focus-visible {
      box-shadow: 0 0 0 3px #2962ff;
    }

    .unit-header span.unit-name {
      flex: 1;
    }

    .unit-header span.chevron {
      margin-left: 10px;
      font-size: 1rem;
    }

    .unit-body {
      display: none;
      padding: 12px 12px 16px;
      background: #fafafa;
    }

    .table-wrapper {
      width: 100%;
      overflow-x: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 8px;
      min-width: 650px;
      background: #ffffff;
    }

    th, td {
      border: 1px solid #ddd;
      padding: 8px;
      font-size: 0.85rem;
    }

    th {
      background-color: #f2f2f2;
      font-weight: 600;
      white-space: nowrap;
    }

    tr:nth-child(even) {
      background-color: #fcfcfc;
    }

    .status-pill {
      padding: 4px 8px;
      border-radius: 999px;
      font-size: 0.75rem;
      font-weight: bold;
      display: inline-block;
      white-space: nowrap;
    }

    .status-critical {
      background-color: var(--critical-bg);
      color: var(--critical-text);
      border: 1px solid var(--critical-border);
    }

    .status-warning {
      background-color: var(--warning-bg);
      color: var(--warning-text);
      border: 1px solid var(--warning-border);
    }

    .status-ok {
      background-color: var(--ok-bg);
      color: var(--ok-text);
      border: 1px solid var(--ok-border);
    }

    .status-expired {
      background-color: var(--expired-bg);
      color: var(--expired-text);
      border: 1px solid var(--expired-border);
    }

    .unit-summary {
      font-size: 0.85rem;
      color: #444;
      margin-top: 4px;
    }

    .unit-summary strong {
      font-weight: 600;
    }

    input[type="text"],
    input[type="date"],
    select {
      font-size: 0.8rem;
      padding: 3px 4px;
      width: 100%;
      box-sizing: border-box;
    }

    select.unit-select {
      min-width: 90px;
    }

    .delete-btn {
      font-size: 0.75rem;
      padding: 2px 6px;
      border-radius: 4px;
      border: 1px solid #b71c1c;
      background: #ffebee;
      color: #b71c1c;
      cursor: pointer;
    }

    .delete-btn:hover {
      background: #ffcdd2;
    }

    @media (max-width: 768px) {
      body {
        padding: 12px;
        font-size: 15px;
      }

      h1 {
        font-size: 1.3rem;
      }

      .unit-header {
        padding: 12px;
      }

      th, td {
        font-size: 0.8rem;
        padding: 6px;
      }
    }
  </style>
</head>

<body>
  <h1>Crash Cart Expiration Dashboard</h1>
  <p>
    Units: 2 SOUTH, 2 EAST, 3 SOUTH, 3 EAST.  
    Edit items in-place, move them between units with the dropdown, and your changes stay saved in this browser.
  </p>

  <div class="top-actions">
    <button id="addItemButton" type="button">Add new blank item</button>
    <button id="resetButton" type="button">Reset to default list</button>
    <span style="font-size:0.8rem;color:#666;">(Saved locally in this browser using localStorage)</span>
  </div>

  <div id="unitsContainer" class="units-container"></div>

  <script>
    // ================================
    // 1 — CONFIG & DEFAULT DATA
    // ================================
    const UNITS = ["2 SOUTH", "2 EAST", "3 SOUTH", "3 EAST"];
    const STORAGE_KEY = "crashCartDashboardV1";

    // Generic placeholder examples ONLY – replace with your real cart items.
    const defaultItems = [
      { id: "item1", unit: "2 SOUTH", name: "Medication A", type: "Medication", location: "Top drawer",    expiration_date: "2025-12-01" },
      { id: "item2", unit: "2 SOUTH", name: "Supply A",     type: "Supply",     location: "Middle drawer", expiration_date: "2026-01-15" },

      { id: "item3", unit: "2 EAST",  name: "Medication B", type: "Medication", location: "Top drawer",    expiration_date: "2025-11-20" },
      { id: "item4", unit: "2 EAST",  name: "Supply B",     type: "Supply",     location: "Side bin",      expiration_date: "2026-03-10" },

      { id: "item5", unit: "3 SOUTH", name: "Medication C", type: "Medication", location: "Top drawer",    expiration_date: "2025-10-05" },
      { id: "item6", unit: "3 SOUTH", name: "Supply C",     type: "Supply",     location: "Middle drawer", expiration_date: "2027-02-01" },

      { id: "item7", unit: "3 EAST",  name: "Medication D", type: "Medication", location: "Top drawer",    expiration_date: "2026-02-12" },
      { id: "item8", unit: "3 EAST",  name: "Supply D",     type: "Supply",     location: "Side bin",      expiration_date: "2025-12-30" }
    ];

    let items = [];
    let nextIdCounter = 1000;

    // ================================
    // 2 — STORAGE HELPERS
    // ================================
    function loadItems() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (raw) {
          items = JSON.parse(raw);
        } else {
          items = defaultItems.map(x => ({ ...x }));
        }
      } catch (e) {
        console.warn("Could not load items from storage:", e);
        items = defaultItems.map(x => ({ ...x }));
      }
      // set next id
      nextIdCounter = items.reduce((max, it) => {
        const num = parseInt(String(it.id).replace(/\D/g, ""), 10);
        return isNaN(num) ? max : Math.max(max, num);
      }, 1000) + 1;
    }

    function saveItems() {
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(items));
      } catch (e) {
        console.warn("Could not save items:", e);
      }
    }

    function resetItems() {
      if (!confirm("Reset to default placeholder list? This will erase your local edits on this device.")) {
        return;
      }
      items = defaultItems.map(x => ({ ...x }));
      saveItems();
      renderUnits();
    }

    // ================================
    // 3 — DATE & STATUS HELPERS
    // ================================
    function parseDate(dateStr) {
      if (!dateStr) return null;
      const parts = dateStr.split("-");
      if (parts.length !== 3) return null;
      const d = new Date(parts[0], parts[1] - 1, parts[2]);
      return isNaN(d.getTime()) ? null : d;
    }

    function daysFromToday(targetDate) {
      if (!targetDate) return null;
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      const diff = targetDate - today;
      return Math.round(diff / (1000 * 60 * 60 * 24));
    }

    function getStatusInfo(days) {
      if (days === null) return { label: "—", className: "" };
      if (days < 0) return { label: "Expired", className: "status-expired" };
      if (days <= 30) return { label: "Critical (≤30d)", className: "status-critical" };
      if (days <= 90) return { label: "Warning (31–90d)", className: "status-warning" };
      return { label: "OK (>90d)", className: "status-ok" };
    }

    function slugifyUnitName(unitName) {
      return unitName.toLowerCase().replace(/[^a-z0-9]+/g, "-");
    }

    // ================================
    // 4 — RENDERING
    // ================================
    function renderUnits() {
      const container = document.getElementById("unitsContainer");
      container.innerHTML = "";

      UNITS.forEach(unitName => {
        const section = buildUnitSection(unitName);
        container.appendChild(section);
      });

      attachFieldListeners();
    }

    function buildUnitSection(unitName) {
      const section = document.createElement("div");
      section.className = "unit-section";

      const header = document.createElement("div");
      header.className = "unit-header";
      header.setAttribute("role", "button");
      header.setAttribute("tabindex", "0");

      const slug = slugifyUnitName(unitName);
      const bodyId = `body-${slug}`;
      header.setAttribute("aria-controls", bodyId);
      header.setAttribute("aria-expanded", "false");

      const nameSpan = document.createElement("span");
      nameSpan.className = "unit-name";
      nameSpan.textContent = unitName;

      const chevron = document.createElement("span");
      chevron.className = "chevron";
      chevron.textContent = "▾";

      header.appendChild(nameSpan);
      header.appendChild(chevron);

      const body = document.createElement("div");
      body.className = "unit-body";
      body.id = bodyId;
      body.setAttribute("aria-hidden", "true");

      // filter + sort items for this unit
      const unitItems = items
        .filter(it => it.unit === unitName)
        .map(it => {
          const d = parseDate(it.expiration_date);
          const days = daysFromToday(d);
          return { ...it, expDate: d, days };
        })
        .sort((a, b) => {
          if (!a.expDate && !b.expDate) return 0;
          if (!a.expDate) return 1;
          if (!b.expDate) return -1;
          return a.expDate - b.expDate;
        });

      // summary
      const unitSummary = document.createElement("div");
      unitSummary.className = "unit-summary";
      if (unitItems.length > 0) {
        const next = unitItems[0];
        const daysText = next.days === null ? "no date" : `${next.days} days`;
        const dateText = next.expiration_date || "—";
        unitSummary.innerHTML =
          `<strong>Next to expire:</strong> ${next.name || "(unnamed)"} (${next.type || "—"}) – ${daysText} (on ${dateText})`;
      } else {
        unitSummary.textContent = "No items assigned to this unit yet.";
      }

      // table
      const tableWrapper = document.createElement("div");
      tableWrapper.className = "table-wrapper";

      const table = document.createElement("table");
      table.innerHTML = `
        <thead>
          <tr>
            <th>Unit</th>
            <th>Item Name</th>
            <th>Type</th>
            <th>Location</th>
            <th>Expiration Date</th>
            <th>Days Remaining</th>
            <th>Status</th>
            <th>Delete</th>
          </tr>
        </thead>
        <tbody></tbody>
      `;
      const tbody = table.querySelector("tbody");

      unitItems.forEach(item => {
        const statusInfo = getStatusInfo(item.days);
        const tr = document.createElement("tr");

        tr.innerHTML = `
          <td>
            <select class="unit-select" data-id="${item.id}" data-field="unit">
              ${UNITS.map(u =>
                `<option value="${u}" ${u === item.unit ? "selected" : ""}>${u}</option>`
              ).join("")}
            </select>
          </td>
          <td>
            <input type="text" data-id="${item.id}" data-field="name" value="${item.name || ""}">
          </td>
          <td>
            <input type="text" data-id="${item.id}" data-field="type" value="${item.type || ""}">
          </td>
          <td>
            <input type="text" data-id="${item.id}" data-field="location" value="${item.location || ""}">
          </td>
          <td>
            <input type="date" data-id="${item.id}" data-field="expiration_date" value="${item.expiration_date || ""}">
          </td>
          <td>${item.days === null ? "—" : item.days}</td>
          <td>
            ${statusInfo.className
              ? `<span class="status-pill ${statusInfo.className}">${statusInfo.label}</span>`
              : statusInfo.label}
          </td>
          <td>
            <button type="button" class="delete-btn" data-id="${item.id}" data-action="delete">X</button>
          </td>
        `;
        tbody.appendChild(tr);
      });

      tableWrapper.appendChild(table);
      body.appendChild(unitSummary);
      body.appendChild(tableWrapper);

      // toggle open/close
      function toggleBody() {
        const isOpen = body.style.display === "block";
        body.style.display = isOpen ? "none" : "block";
        header.setAttribute("aria-expanded", String(!isOpen));
        body.setAttribute("aria-hidden", String(isOpen));
        chevron.textContent = isOpen ? "▾" : "▴";
      }

      header.addEventListener("click", toggleBody);
      header.addEventListener("keydown", e => {
        if (e.key === "Enter" || e.key === " ") {
          e.preventDefault();
          toggleBody();
        }
      });

      section.appendChild(header);
      section.appendChild(body);
      return section;
    }

    // ================================
    // 5 — EVENT HANDLERS
    // ================================
    function attachFieldListeners() {
      const container = document.getElementById("unitsContainer");

      // inputs and selects
      container.querySelectorAll("input[data-id], select[data-id]").forEach(el => {
        const handler = event => {
          const id = el.getAttribute("data-id");
          const field = el.getAttribute("data-field");
          const value = el.value;

          const idx = items.findIndex(it => String(it.id) === String(id));
          if (idx === -1) return;

          items[idx][field] = value;
          saveItems();
          renderUnits();
        };

        el.onchange = handler;
        if (el.tagName.toLowerCase() === "input" && el.type === "text") {
          el.oninput = handler;
        }
      });

      // delete buttons
      container.querySelectorAll("button[data-action='delete']").forEach(btn => {
        btn.onclick = () => {
          const id = btn.getAttribute("data-id");
          items = items.filter(it => String(it.id) !== String(id));
          saveItems();
          renderUnits();
        };
      });
    }

    function addNewItem() {
      const newItem = {
        id: "item" + nextIdCounter++,
        unit: UNITS[0], // default to first unit; you can change via dropdown
        name: "",
        type: "",
        location: "",
        expiration_date: ""
      };
      items.push(newItem);
      saveItems();
      renderUnits();
    }

    // ================================
    // 6 — INIT
    // ================================
    document.addEventListener("DOMContentLoaded", () => {
      loadItems();
      renderUnits();

      document.getElementById("resetButton").addEventListener("click", resetItems);
      document.getElementById("addItemButton").addEventListener("click", addNewItem);
    });
  </script>
</body>
</html>
